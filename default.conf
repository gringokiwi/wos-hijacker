server {
    listen 8080;
    server_name _;
    
    # DNS resolver for proxy_pass
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;
    
    # Health check for Railway
    location /health {
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
    
    # Lightning address endpoint - redirect .co to .com
    location ~ ^/\.well-known/lnurlp/(\w+)$ {
        set $username $1;
        
        # Log the redirect for monitoring
        access_log /var/log/nginx/redirect.log main;
        
        # Proxy to the correct walletofsatoshi.com endpoint
        proxy_pass https://walletofsatoshi.com/.well-known/lnurlp/$username;
        proxy_set_header Host walletofsatoshi.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Pass through all query parameters
        proxy_pass_request_headers on;
        
        # Handle timeouts
        proxy_connect_timeout 10s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
    }
    
    # Catch-all for any other requests
    location / {
        return 301 https://walletofsatoshi.com$request_uri;
    }
}